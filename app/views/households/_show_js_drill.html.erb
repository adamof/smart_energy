<%= javascript_tag do %>
  function setChart(drilldown, type, pointClick, yAxis) {
    if(pointClick){
      chart.setTitle({
        text: drilldown.chart_name
      });
      chart.xAxis[0].setCategories(drilldown.categories);
      chart.series[0].remove();
    }
    chart.yAxis[yAxis].setTitle({text: drilldown.units});

    chart.addSeries({
      name: drilldown.series_name,
      data: drilldown.data,
      level: drilldown.level,
      color: drilldown.color,
      type: type,
      yAxis: yAxis,
      dataLabels: {
        enabled: false,
        color: drilldown.color
      }
    });
  }

  function writePeriod (drilldown) {
    $(".period-shown #unit").val(drilldown.unit);
    $(".period-shown #date").val(drilldown.date);
    $(".period-shown #type").val(drilldown.type);
  }

  function changeType(series, newType) {
    var dataArray = [],
        points = series.data;
    series.chart.addSeries({
      type: newType,
      name: series.name,
      color: series.color,
      data: series.options.data,
      pointInterval: series.pointInterval,
      pointStart: series.xData[0]
    }, false);
    
    series.remove();
  }

  $(function(){
    chartType = "<%= current_user.try(:chart_type) || 'column' %>";

    $('#chart_type').change(function() {
      chartType = $(this).val();
      for(i = 0, l = chart.series.length; i < l; ++i) {
        var series = window.chart.series[0],
            newType = chartType;
        changeType(series, newType);
      }
    });

    $(".chart-toggler").change(function() {
      var axis = this.value,
          axis_n = parseInt($(this).attr("axis_n")),
          color = $(this).attr("color"),
          type = $(this).attr("series_type");

      if(this.checked){
        // TODO add the axis
        $.getJSON("<%= readings_household_path %>", 
          { date: $(".period-shown #date").val(),
            unit: $(".period-shown #unit").val(),
            type: $(".period-shown #type").val(),
            axis: axis,
            id: <%= @household.id %> },
          function (result) {
            console.log(result);
            setChart(result, type, false, axis_n);
          }
        );
      }else{
        chart.yAxis[axis_n].series[0].destroy();
      }
    });

    var colors = Highcharts.getOptions().colors,
        chartTitle = 'Yearly <%= @type %> usage',
        categories = <%= raw @data[:categories] %>,
        name = '<%= raw @data[:name] %>',
        level = <%= raw @data[:level] %>,
        data = <%= raw @data[:data].to_json %>,
        default_units = '<%= raw @data[:units] %>';
   
    chart = new Highcharts.Chart({
      chart: {
        renderTo: 'chart_container',
        type: chartType
      },
      title: {
        text: chartTitle
      },
      subtitle: {
        text: 'Click on a column to view monthly usage. Click again to view daily usage.'
      },
      xAxis: {
        labels: {
          rotation: -45,
          align: "right",
          style: {
            fontSize: "13px",
            fontFamily: "Verdana, sans-serif"
          }
        },
        // gridLineColor: "#bfbfc0",
        // gridLineDashStyle: "ShortDash",
        // gridLineWidth: "1",
        categories: categories                     
      },
      yAxis: [
        {
          type: "column",
          title: {
            text: default_units,
            style: {
              color: '#4572A7'
            }
          },
          labels: {
            style: {
              color: '#4572A7'
            }
          }
        },
        {
          title: {
            text: "Carbon generated",
            style: {
              color: '#89A54E'
            }
          },
          min: -200,
          labels: {
            style: {
              color: '#89A54E'
            }
          },
          opposite: true,
          showEmpty: false
        },
        {
          plotOptions: {
            type: "spline"
          },
          title: {
            text: "Carbon intensity",
            style: {
              color: '#AA4643'
            }
          },
          min: -200,
          labels: {
            style: {
              color: '#AA4643'
            }
          },
          opposite: true,
          showEmpty: false
        }
      ],
      plotOptions: {
        series: {
          cursor: 'pointer',
          point: {
            events: {
              click: function() {
                writePeriod(this);
                // TODO check to see which toggles we have on
                // so that I can load them as well maybe in a single call?
                $.getJSON("<%= readings_household_path %>", 
                  { date: this.date,
                    unit: this.unit,
                    type: this.type,
                    axis: this.axis,
                    id: <%= @household.id %> }, 
                  function(drilldown) {
                    // if (this.level!=3) { // drill down
                    setChart(drilldown, chartType, true, 0);
                    // } else { // restore
                    //   console.log("restore");
                    //   chart.setTitle({
                    //     text: chartTitle
                    //   });
                    //   setChart({
                    //     name: name, 
                    //     categories: categories, 
                    //     data: data, 
                    //     level: level,
                    //     units: default_units
                    //   }, colors[0], chartType);
                    // }
                  }
                );
              }
            }
          },
          marker: {
            symbol: "circle"
          },
          dataLabels: {
            // enabled: true,
            // color: colors[0],
            // style: {
            //    fontWeight: 'bold'
            // },
            formatter: function() {
              return this.y;
            }
            // rotation: -60
          }               
        }
      },
      // tooltip: {
      //    formatter: function() {
      //       var point = this.point, s = '';
            
      //        switch (this.series.options.level) {
      //           case 0:
      //               s = 'LEVEL ONE<br/>';
      //               s += ' INSTRUCTIONS HERE 111';
      //               break;
                
      //           case 1:
      //               s = 'LEVEL TWO INSTRUCTIONS HERE <br/>';
      //               s += ' INSTRUCTIONS HERE 222';
      //               break;
                
      //           case 2:
      //               s = 'LEVEL THREE INSTRUCTIONS HERE<br/>';
      //               s += 'INSTRUCTIONS HERE 333';
      //               break;
      //        }
             
             
      //       return s;
      //    }
      // },
      series: [{
        name: name,
        level: level,
        data: data,
        color: "#4572A7",
        yAxis: 0
      }],
      exporting: {
        enabled: false
      }
    });
  });
<% end %>