<%= javascript_tag do %>
  $(function(){
    chartType = "<%= current_user.chart_type %>";
    function changeType(series, newType) {
      var dataArray = [],
          points = series.data;
      series.chart.addSeries({
          type: newType,
          name: series.name,
          color: series.color,
          data: series.options.data,
          pointInterval: series.pointInterval,
          pointStart: series.xData[0]
      }, false);
      
      series.remove();
    }
    $('#chart_type').change(function() {
      chartType = $(this).val();
      for(i = 0, l = chart.series.length; i < l; ++i) {
        var series = window.chart.series[0],
            newType = chartType;
        changeType(series, newType);
      }
    });

    $(".chart-toggler").change(function() {
      var axis = this.value;
      if(this.checked){
        // TODO add the axis
        // TODO add the series
        $.getJSON("<%= readings_household_path %>", 
          { date: $(".period-shown #date").val(),
            unit: $(".period-shown #unit").val(),
            type: $(".period-shown #type").val(),
            axis: axis,
            id: <%= @household.id %> },
          function (result) {
            // TODO add the actual code for the other axis here
            console.log(result);
          }
        );
      }else{
        // TODO remove the series
        // TODO remove the axis
      }
    });

  var colors = Highcharts.getOptions().colors,
      chartTitle = 'Yearly <%= @type %> usage',
      categories = <%= raw @data[:categories] %>,
      name = '<%= raw @data[:name] %>',
      level = <%= raw @data[:level] %>,
      data = <%= raw @data[:data].to_json %>,
      default_units = '<%= raw @data[:units] %>';
   
   function setChart(drilldown, color, type) {
      chart.xAxis[0].setCategories(drilldown.categories);
      chart.series[0].remove();

      chart.yAxis[0].setTitle({text: drilldown.units});

      chart.addSeries({
         name: drilldown.name,
         data: drilldown.data,
         level: drilldown.level,
         color: color,
         type: type
      });
   }

  function writePeriod (drilldown) {
    $(".period-shown #unit").val(drilldown.unit);
    $(".period-shown #date").val(drilldown.date);
    $(".period-shown #type").val(drilldown.type);
  }
   
   chart = new Highcharts.Chart({
      chart: {
         renderTo: 'chart_container', 
         type: chartType
      },
      title: {
         text: chartTitle
      },
      subtitle: {
         text: 'Click on a column to view monthly usage. Click again to view daily usage.'
      },
      xAxis: {
        labels: {
          rotation: -45,
          align: "right",
          style: {
            fontSize: "13px",
            fontFamily: "Verdana, sans-serif"
          }
        },
        // gridLineColor: "#bfbfc0",
        // gridLineDashStyle: "ShortDash",
        // gridLineWidth: "1",
        categories: categories                     
      },
      yAxis: [
        {
          title: {
            text: default_units
          }
        },
        {
          title: {
            text: "secondary"
          },
          opposite: true
        }
      ],
      plotOptions: {
         series: {
            cursor: 'pointer',
            point: {
               events: {
                  click: function() {
                    writePeriod(this);
                    // TODO check to see which toggles we have on
                    // so that I can load them as well maybe in a single call?
                    $.getJSON("<%= readings_household_path %>", 
                      { date: this.date,
                        unit: this.unit,
                        type: this.type,
                        axis: this.axis,
                        id: <%= @household.id %> }, 
                      function(drilldown) {
                        if (this.level!=3) { // drill down
                          
                          chart.setTitle({
                            text: drilldown.name
                          });

                          setChart(drilldown, colors[drilldown.level], chartType);
                        } else { // restore
                            chart.setTitle({
                              text: chartTitle
                            });
                            setChart({
                              name: name, 
                              categories: categories, 
                              data: data, 
                              level: level,
                              units: default_units
                            }, colors[0], chartType);
                        }
                    });

                    var drilldown = this.drilldown;
                  }
               }
            },
            marker: {
              symbol: "circle"
            },
            dataLabels: {
               enabled: true,
               color: colors[0],
               // style: {
               //    fontWeight: 'bold'
               // },
               formatter: function() {
                  return this.y;
               }
               // rotation: -60
            }               
         }
      },
      // tooltip: {
      //    formatter: function() {
      //       var point = this.point, s = '';
            
      //        switch (this.series.options.level) {
      //           case 0:
      //               s = 'LEVEL ONE<br/>';
      //               s += ' INSTRUCTIONS HERE 111';
      //               break;
                
      //           case 1:
      //               s = 'LEVEL TWO INSTRUCTIONS HERE <br/>';
      //               s += ' INSTRUCTIONS HERE 222';
      //               break;
                
      //           case 2:
      //               s = 'LEVEL THREE INSTRUCTIONS HERE<br/>';
      //               s += 'INSTRUCTIONS HERE 333';
      //               break;
      //        }
             
             
      //       return s;
      //    }
      // },
      series: [{
         name: name,
         level: level,
         data: data,
         color: colors[0]
      }],
      exporting: {
         enabled: false
      }
   });
  })

<% end %>